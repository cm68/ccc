# cpp - C Preprocessor
#
# Builds the preprocessor that produces .x and .i files

# Disable built-in lex rule (.x -> .c) to avoid conflicts with lexeme output files
%.c: %.x

DEST ?= $(CURDIR)/../root

CC = gcc

CCC = $(DEST)/bin/ccc
OUTDIR = stage1

# Compiler-specific flags
ifeq ($(CC),gcc)
WARNS = -Wall -Werror -pedantic \
-Wdeclaration-after-statement -Werror=declaration-after-statement \
-Werror=implicit-function-declaration
CFLAGS = -m32 -std=c89 -g -O0 $(WARNS)
else ifeq ($(CC),ccc)
CFLAGS = -DCCC
endif

SRCS = cpp.c lex.c io.c macro.c kw.c emit.c util.c kwtab.c
OBJS = $(SRCS:.c=.o)

all: cpp

cpp: $(OBJS)
	$(CC) $(CFLAGS) -o cpp $(OBJS)

# Generate skip-optimized keyword table
mkkw: mkkw.c
	$(CC) -o mkkw mkkw.c

kwtab.c: mkkw
	@echo "/* Auto-generated by mkkw - do not edit */" > kwtab.c
	@echo '#include "cpp.h"' >> kwtab.c
	@echo '#define HI 0x80' >> kwtab.c
	./mkkw >> kwtab.c

%.o: %.c cpp.h
	$(CC) $(CFLAGS) -c -o $@ $<

# Stage: compile with cross ccc to Z80 .o files
stage1:
	mkdir -p $(OUTDIR)
	@for f in $(SRCS); do \
	  b=$${f%.c}; \
	  printf "%-20s" "$$f: "; \
	  $(CCC) -DCCC -k -P -s $$f 2> $(OUTDIR)/$$b.err 1>&2 && { echo "ok"; rm -f $(OUTDIR)/$$b.err; } || echo "FAIL"; \
      mv $$b.i $$b.x $$b.1 $$b.2 $$b.pp $$b.s $$b.o $(OUTDIR) 2>/dev/null ; \
	done

# Size report for stage1 objects
sizefile: Makefile
	$(MAKE) stage1 CC=ccc
	@$(DEST)/bin/wssize $(addprefix $(OUTDIR)/,$(OBJS)) | \
	awk \
		'{ t+=$$1 ; d+=$$2 ; b+=$$3 ; a+=$$4; print } \
		END {printf "%7d %7d %7d %7d %19s\n", t, d, b, a, "cpp total" }' \
	 > sizefile

clean:
	rm -f *.o

clobber: clean
	rm -f cpp mkkw kwtab.c

install: cpp
	cp cpp $(DEST)/bin

.PHONY: all clean clobber install stage1 sizefile
#
# vim: tabstop=4 shiftwidth=4 expandtab:
#
